parameters:
- name: svcConnAzureRm
  type: string
- name: dependsOn  
  type: object

stages:
- stage: common
  displayName: Common
  dependsOn: ${{ parameters.dependsOn }}
  pool:
    vmImage: ubuntu-latest 
  jobs:
  - deployment: Infrastructure
    displayName: Ensure Common Infra Resources
    # all environments manually enabled by authorised person on first run 
    environment: common
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            clean: true              
          - template: $(System.DefaultWorkingDirectory)/Devops/Common/Templates/tfStateAz.yml
            parameters:
              svcConnAzureRm: ${{ parameters.svcConnAzureRm }}
          - template: $(System.DefaultWorkingDirectory)/Devops/Common/Templates/replaceTokens.yml
            parameters:
              targetFiles: |
                Devops/Infra/Terraform/Common/variables.tf          
          - template: $(System.DefaultWorkingDirectory)/Devops/Common/Templates/tfInitAzRm.yml
            parameters:
              svcConnAzureRm: ${{ parameters.svcConnAzureRm }}
              workingDirectory: '$(System.DefaultWorkingDirectory)/Devops/Infra/Terraform/Common'
          - template: $(System.DefaultWorkingDirectory)/Devops/Common/Templates/tfApplyAzRm.yml
            parameters:
              svcConnAzureRm: ${{ parameters.svcConnAzureRm }}
              workingDirectory: '$(System.DefaultWorkingDirectory)/Devops/Infra/Terraform/Common'