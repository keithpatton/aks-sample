name: $(Date:yyyyMMdd)$(Rev:.r)_${{ parameters.region }}_${{ parameters.env }}

trigger: none

resources:
- repo: self

parameters:
- name: regions
  displayName: 'Regions'
  type: object
  default: ['au1']
- name: envs
  displayName: 'Environments'
  type: object
  default: ['dev']
- name: region
  displayName: 'Target Region'
  type: string
  values:
  - au1
  default: au1
- name: env
  displayName: 'Target Environment'
  type: string
  values:
  - dev
  default: dev  
- name: tenants
  displayName: 'Tenants'
  type: object
  default:
    - name: tenant1
    - name: tenant2
- name: destroy
  displayName: 'Destroy Infra (Before Apply)'
  type: boolean
  default: false
- name: apply
  displayName: 'Apply Infra'
  type: boolean
  default: true

variables:
- template: ../../Common/Templates/variables.yml  
  parameters:
    tenants: ${{ parameters.tenants }}
    region: ${{ parameters.region }}
    env: ${{ parameters.env }}
- template: ../Templates/variables.yml
  parameters:
    region: ${{ parameters.region }}
    env: ${{ parameters.env }}

stages:
- ${{ each region in parameters.regions }}:
  - ${{ each env in parameters.envs }}:
    - template: ../Templates/stage.yml
      parameters:
        regionStage: '${{ region }}'
        envStage: '${{ env }}'
        regionTarget: ${{ parameters.region }}
        envTarget: ${{ parameters.env }}
        dependsOn: []
        apply: ${{ parameters.apply }}
        destroy: ${{ parameters.destroy }}